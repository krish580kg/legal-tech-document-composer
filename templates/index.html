<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Legal Tech Adaptive Document Composer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{background:#f3f4f6;transition:background 0.2s,color 0.2s;}
    .brand-bar{background:#111827;color:#f9fafb;}
    .brand-logo{font-weight:700;letter-spacing:0.03em;}
    textarea{white-space:pre-wrap;font-family:"JetBrains Mono","Courier New",monospace;font-size:0.9rem;}
    .badge-tech{font-size:0.7rem;margin-left:0.35rem;}
    .card{border-radius:0.75rem;border:1px solid #e5e7eb;}
    .card-header{background:#f9fafb;border-bottom:1px solid #e5e7eb;}
    .pill-label{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.06em;}

    /* Dark mode */
    body.dark-mode{background:#020617;color:#e5e7eb;}
    body.dark-mode .brand-bar{background:#000000;color:#e5e7eb;}
    body.dark-mode .card{background:#020617;border-color:#1f2937;}
    body.dark-mode .card-header{background:#020617;border-bottom-color:#1f2937;}
    body.dark-mode textarea,
    body.dark-mode select{
      background:#020617;
      color:#e5e7eb;
      border-color:#1f2937;
    }
    body.dark-mode .form-text,
    body.dark-mode .text-muted{color:#9ca3af !important;}
  </style>
</head>
<body>

<nav class="brand-bar py-2">
  <div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <span class="brand-logo">LexDraft</span>
      <span class="d-none d-sm-inline text-secondary" style="font-size:0.8rem;">Adaptive document composer</span>
    </div>
    <div class="mt-2 mt-md-0 d-flex align-items-center">
      <span class="badge bg-secondary badge-tech">Flask backend</span>
      <span class="badge bg-info text-dark badge-tech">AI text analysis</span>
      <span class="badge bg-success badge-tech">Smart clause engine</span>
      <button id="theme-toggle" class="btn btn-sm btn-outline-light ms-2">Dark</button>
    </div>
  </div>
</nav>

<div class="container py-4">

  <div class="mb-3 text-center">
    <span class="pill-label text-muted">Smart drafting for NDA & employment agreements</span>
  </div>

  <div class="row g-3">

    <div class="col-lg-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="pill-label text-muted">Step 1 Â· Input</span>
          <span class="badge bg-light text-dark border">Draft settings</span>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Document type</label>
            <select id="docType" class="form-select">
              <option value="nda">Non-Disclosure Agreement (NDA)</option>
              <option value="employment">Employment Agreement</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label fw-semibold">
              Use-case / Requirements
              <span class="badge bg-secondary badge-tech">Analysed by AI</span>
            </label>
            <textarea id="requirements" class="form-control" rows="6"
                      placeholder="Example: NDA between Alpha Innovations Pvt Ltd and Rohan Sharma for a startup product under development. Work is remote and involves 2 interns handling confidential research. Agreement valid for 6 months in Bengaluru."></textarea>
            <div class="form-text">
              Include details like parties, startup, remote work, interns, salary, locations, duration.
            </div>
            <div id="char-count" class="small text-muted mt-1">0 characters</div>
          </div>

          <!-- Mic button + status -->
          <button id="mic-btn" type="button" class="btn btn-outline-secondary w-100 mb-2">
            ðŸŽ¤ Speak instead of typing
          </button>
          <div id="mic-status" class="small text-muted mb-2"></div>

          <button id="generate-btn" class="btn btn-primary w-100 mb-2">Generate draft</button>
          <button id="download-btn" class="btn btn-outline-secondary w-100 mb-2">Download draft (PDF)</button>
          <button id="copy-btn" class="btn btn-outline-dark w-100 mb-2">Copy draft</button>
          <button id="reset-btn" class="btn btn-link w-100">Reset form</button>

          <div id="status-text" class="form-text mt-2"></div>
          <div id="ai-summary" class="small text-muted mt-1"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card mb-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="pill-label text-muted">Step 2 Â· Analysis</span>
          <span class="text-muted" style="font-size:0.8rem;">AI entity extraction</span>
        </div>
        <div class="card-body">
          <p class="text-muted mb-2">
            The system analyses your requirements text and highlights detected entities such as
            organisations, people and locations.
          </p>
          <ul id="entities-list" class="mb-0"></ul>
        </div>
      </div>

      <div class="card shadow-sm" id="draft-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="pill-label text-muted">Step 3 Â· Generated draft</span>
          <span class="text-muted" style="font-size:0.8rem;">Template clauses + adaptive clauses</span>
        </div>
        <div class="card-body">
          <textarea id="draft" class="form-control" rows="18"
                    placeholder="Generated legal draft will appear here. You can edit the text before exporting."></textarea>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  const btn = document.getElementById('generate-btn');
  const downloadBtn = document.getElementById('download-btn');
  const copyBtn = document.getElementById('copy-btn');
  const resetBtn = document.getElementById('reset-btn');
  const draftBox = document.getElementById('draft');
  const entitiesList = document.getElementById('entities-list');
  const statusText = document.getElementById('status-text');
  const aiSummary = document.getElementById('ai-summary');
  const requirementsBox = document.getElementById('requirements');
  const charCount = document.getElementById('char-count');
  const themeToggle = document.getElementById('theme-toggle');
  const draftCard = document.getElementById('draft-card');

  // Load saved data (auto-save + theme)
  window.addEventListener('DOMContentLoaded', () => {
    const savedReq = localStorage.getItem('lexdraft_requirements');
    const savedDraft = localStorage.getItem('lexdraft_draft');
    const savedDocType = localStorage.getItem('lexdraft_docType');
    const savedTheme = localStorage.getItem('lexdraft_theme');

    if (savedReq) {
      requirementsBox.value = savedReq;
      charCount.textContent = savedReq.length + " characters";
    }
    if (savedDraft) {
      draftBox.value = savedDraft;
    }
    if (savedDocType) {
      document.getElementById('docType').value = savedDocType;
    }
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      themeToggle.textContent = "Light";
    }
  });

  // Character counter + auto-save on typing
  requirementsBox.addEventListener('input', () => {
    const len = requirementsBox.value.length;
    charCount.textContent = len + " characters";
    localStorage.setItem('lexdraft_requirements', requirementsBox.value);
  });

  draftBox.addEventListener('input', () => {
    localStorage.setItem('lexdraft_draft', draftBox.value);
  });

  document.getElementById('docType').addEventListener('change', (e) => {
    localStorage.setItem('lexdraft_docType', e.target.value);
  });

  // Theme toggle + save
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    themeToggle.textContent = isDark ? "Light" : "Dark";
    localStorage.setItem('lexdraft_theme', isDark ? 'dark' : 'light');
  });

  btn.addEventListener('click', async () => {
    const requirements = requirementsBox.value.trim();
    const docType = document.getElementById('docType').value;
    if (!requirements) {
      statusText.textContent = "Please enter requirements text.";
      statusText.classList.add("text-danger");
      return;
    }
    statusText.textContent = "Generating draftâ€¦";
    statusText.classList.remove("text-danger");
    aiSummary.textContent = "";
    btn.disabled = true;
    try {
      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ docType, requirements })
      });
      const data = await res.json();
      draftBox.value = data.draft || "";
      localStorage.setItem('lexdraft_draft', draftBox.value);

      entitiesList.innerHTML = "";
      if (data.entities && data.entities.length > 0) {
        data.entities.forEach(([text, label]) => {
          const li = document.createElement('li');
          li.textContent = text + " (" + label + ")";
          li.classList.add('text-primary');
          entitiesList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = "No entities detected.";
        li.classList.add('text-muted');
        entitiesList.appendChild(li);
      }
      const keywords = data.keywords || [];
      const adaptiveCount = data.adaptive_count || 0;
      if (keywords.length > 0) {
        aiSummary.textContent = "Keywords detected: " + keywords.join(", ") +
          " Â· Adaptive clauses added: " + adaptiveCount + ".";
      } else {
        aiSummary.textContent = "Draft generated from base template.";
      }
      statusText.textContent = "Draft ready.";

      // Auto-scroll to draft
      draftCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch (err) {
      console.error(err);
      statusText.textContent = "Unable to generate draft.";
      statusText.classList.add("text-danger");
    } finally {
      btn.disabled = false;
    }
  });

  downloadBtn.addEventListener('click', () => {
    window.print();
  });

  // Copy draft button
  copyBtn.addEventListener('click', () => {
    if (!draftBox.value.trim()) {
      statusText.textContent = "No draft to copy.";
      statusText.classList.add("text-danger");
      return;
    }
    navigator.clipboard.writeText(draftBox.value).then(() => {
      statusText.textContent = "Draft copied to clipboard.";
      statusText.classList.remove("text-danger");
    }).catch(() => {
      statusText.textContent = "Unable to copy draft.";
      statusText.classList.add("text-danger");
    });
  });

  // Reset button
  resetBtn.addEventListener('click', () => {
    requirementsBox.value = "";
    draftBox.value = "";
    entitiesList.innerHTML = "";
    statusText.textContent = "";
    aiSummary.textContent = "";
    document.getElementById('docType').value = "nda";
    charCount.textContent = "0 characters";
    document.getElementById('mic-status').textContent = "";
    localStorage.removeItem('lexdraft_requirements');
    localStorage.removeItem('lexdraft_draft');
    localStorage.removeItem('lexdraft_docType');
  });

  // ðŸŽ¤ Speech-to-text (clean, no repetition)
  const micBtn = document.getElementById('mic-btn');
  const micStatus = document.getElementById('mic-status');

  let recognition = null;

  if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang = 'en-IN';
    recognition.continuous = false;
    recognition.interimResults = false;  // only final text

    recognition.onstart = () => {
      micStatus.textContent = "Listening... speak clearly.";
    };

    recognition.onerror = (event) => {
      micStatus.textContent = "Mic error: " + event.error;
    };

    recognition.onend = () => {
      micStatus.textContent = "Stopped listening.";
    };

    recognition.onresult = (event) => {
      let finalText = event.results[0][0].transcript;
      requirementsBox.value = (requirementsBox.value + " " + finalText).trim();
      const len = requirementsBox.value.length;
      charCount.textContent = len + " characters";
      localStorage.setItem('lexdraft_requirements', requirementsBox.value);
    };

    micBtn.addEventListener('click', () => {
      try { recognition.start(); } catch (e) {}
    });
  } else {
    micStatus.textContent = "Speech input not supported in this browser.";
    micBtn.disabled = true;
  }
</script>

</body>
</html>
